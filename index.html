<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emulator</title>
    <style>
        body {
            background: #ddd;
        }
        canvas {
            display: block;
            margin: 50px auto;
            border: 3px solid #666;
            background: #fff;
        }
        .actions {
            display: flex;
            justify-content: center;
        }
        .actions > div {
            padding: 5px;
            color: #bbb;
        }
        .connected.active {
            color: #3ac11f;
        }
        .disconnected.active {
            color: #ff0000;
        }
    </style>
</head>
<body>
    <canvas></canvas>
    <div class="actions">
        <div class="connected">Connected</div>
        <div class="disconnected active">Disconnected</div>
    </div>

    <script src="/node_modules/socket.io-client/dist/socket.io.js"></script>
    <script>
        const socket = io('//:3000'),
                position = null,
                stepAmount = 10,
                mainCanvas = document.querySelector('canvas'),
                drawCanvas = document.createElement('canvas'),
                refreshCanvas = document.createElement('canvas'),
                mainCtx = mainCanvas.getContext('2d'),
                drawCtx = drawCanvas.getContext('2d'),
                refreshCtx = refreshCanvas.getContext('2d')

        let points = [];

        socket.on('connect', socket => {
            document.querySelector('.connected').classList.add('active')
            document.querySelector('.disconnected').classList.remove('active')
        })
        socket.on('disconnect', socket => {
            document.querySelector('.connected').classList.remove('active')
            document.querySelector('.disconnected').classList.add('active')
        })

        socket.on('move', position => {
            points.push(position);
        })

        socket.on('history', history => {
            console.log("Received position history")
            points = history
        })

        socket.on('init', data => {
            init(data.board, data.microsteppingMultiplier);
        })

        function draw({x: xFrom,y: yFrom},{x: xTo,y: yTo}) {
            xFrom /= 4;
            yFrom /= 4;
            xTo /= 4;
            yTo /= 4;

            drawCtx.beginPath()
            drawCtx.moveTo(xFrom, yFrom)
            drawCtx.lineTo(xTo, yTo)
            drawCtx.stroke()
            drawCtx.closePath();

            refreshCtx.clearRect(0, 0, refreshCanvas.width, refreshCanvas.height)
            refreshCtx.beginPath()
            refreshCtx.moveTo(0, 0)
            refreshCtx.lineTo(xTo, yTo)
            refreshCtx.stroke()
            refreshCtx.moveTo(refreshCanvas.width, 0)
            refreshCtx.lineTo(xTo, yTo)
            refreshCtx.stroke()
            refreshCtx.closePath();
        }

        let lastPoint = null;

        function drawTo() {

            if (points.length > 0) {

                if (lastPoint === null) {
                    lastPoint = points.shift()
                }

                points.forEach(point => {
                    draw(lastPoint, point)
                    points.shift()
                    lastPoint = point;
                })


                mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height)
                mainCtx.drawImage(refreshCanvas, 0, 0)
                mainCtx.drawImage(drawCanvas, 0, 0)
            }

            requestAnimationFrame(drawTo)
        }

        function init(board, microsteppingMultiplier) {

            drawCanvas.width = board.width/microsteppingMultiplier;
            drawCanvas.height = board.height/microsteppingMultiplier;

            refreshCanvas.width = board.width/microsteppingMultiplier;
            refreshCanvas.height = board.height/microsteppingMultiplier;

            mainCanvas.width = board.width/microsteppingMultiplier;
            mainCanvas.height = board.height/microsteppingMultiplier;
            
            drawCtx.lineWidth = 3
            drawCtx.strokeStyle = '#3ac11f'
            refreshCtx.strokeStyle = '#aaa'
            refreshCtx.lineWidth = 3
            refreshCtx.setLineDash([3, 3])

            requestAnimationFrame(drawTo);
        }

    </script>
</body>
</html>