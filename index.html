<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emulator</title>
    <style>
        body {
            background: #ddd;
        }
        canvas {
            display: block;
            margin: 50px auto;
            border: 3px solid #666;
            width: 750px;
            height: 500px;
            background: #fff;
        }
        .actions {
            display: flex;
            justify-content: center;
        }
        .actions > div {
            padding: 5px;
            color: #bbb;
        }
        .connected.active {
            color: #3ac11f;
        }
        .disconnected.active {
            color: #ff0000;
        }
    </style>
</head>
<body>
    <canvas width="1500" height="1000"></canvas>
    <div class="actions">
        <div class="connected">Connected</div>
        <div class="disconnected active">Disconnected</div>
    </div>

    <script src="/node_modules/socket.io-client/dist/socket.io.js"></script>
    <script>
        const socket = io('//:3000'),
                position = null,
                stepAmount = 10,
                mainCanvas = document.querySelector('canvas'),
                drawCanvas = document.createElement('canvas'),
                refreshCanvas = document.createElement('canvas'),
                mainCtx = mainCanvas.getContext('2d'),
                drawCtx = drawCanvas.getContext('2d'),
                refreshCtx = refreshCanvas.getContext('2d')

        drawCanvas.width = refreshCanvas.width = mainCanvas.width
        drawCanvas.height = refreshCanvas.height = mainCanvas.height
        drawCtx.lineWidth = 3
        drawCtx.strokeStyle = '#3ac11f'
        refreshCtx.strokeStyle = '#aaa'
        refreshCtx.lineWidth = 3
        refreshCtx.setLineDash([3, 3])

        socket.on('connect', socket => {
            document.querySelector('.connected').classList.add('active')
            document.querySelector('.disconnected').classList.remove('active')
        })
        socket.on('disconnect', socket => {
            document.querySelector('.connected').classList.remove('active')
            document.querySelector('.disconnected').classList.add('active')
        })

        socket.on('move', position => {
            console.log("Received position")
            drawTo(position)
        })

        socket.on('history', history => {
            console.log("Received position history")
            history.forEach(newPosition => {
                if (this.position === null) {
                    this.position = newPosition
                    drawCtx.moveTo(newPosition.x, newPosition.y)
                    return
                }
                drawTo(newPosition)
            })
        })

        function drawTo({ x, y }) {
            drawCtx.lineTo(x, y)
            drawCtx.stroke()

            refreshCtx.clearRect(0, 0, refreshCanvas.width, refreshCanvas.height)
            refreshCtx.beginPath()
            refreshCtx.moveTo(0, 0)
            refreshCtx.lineTo(x, y)
            refreshCtx.stroke()
            refreshCtx.moveTo(refreshCanvas.width, 0)
            refreshCtx.lineTo(x, y)
            refreshCtx.stroke()

            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height)
            mainCtx.drawImage(refreshCanvas, 0, 0)
            mainCtx.drawImage(drawCanvas, 0, 0)
        }
    </script>
</body>
</html>