<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emulator</title>
    <style>
        body, html {
            padding: 0;
        }
        body {
            margin: 20px;
            background: #ddd;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border: 3px solid #666;
            background: #fff;
        }
        .actions > div {
            padding: 5px;
            color: #bbb;
        }
        .overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            opacity: 0.3;
            background: repeating-linear-gradient(
                    -55deg,
                    #222,
                    #222 30px,
                    #333 30px,
                    #333 60px
            );
        }
        .overlay.active {
            display: block;
        }
        .disconnected {
            display: none;
            position: absolute;
            font-family: sans-serif;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-transform: uppercase;
            border: 6px solid crimson;
            color: crimson;
            padding: 2px 10px;
            font-size: 4em;
            background: #FFF;
        }
        .disconnected.active {
            display: block;
        }
    </style>
</head>
<body>
    <canvas width="1875" height="1100"></canvas>
    <div class="overlay active"></div>
    <div class="disconnected active">Disconnected</div>

    <script src="/node_modules/socket.io-client/dist/socket.io.js"></script>
    <script>
        const socket = io('//:3000'),
                position = null,
                stepAmount = 10,
                mainCanvas = document.querySelector('canvas'),
                drawCanvas = document.createElement('canvas'),
                refreshCanvas = document.createElement('canvas'),
                mainCtx = mainCanvas.getContext('2d'),
                drawCtx = drawCanvas.getContext('2d'),
                refreshCtx = refreshCanvas.getContext('2d')

        function setCanvasSize() {
            const canvasSizeRatio = mainCanvas.height / mainCanvas.width;

            const canvasHeight = window.innerHeight - 46;
            const canvasWidth = canvasHeight / canvasSizeRatio;

            mainCanvas.style.width = `${canvasWidth}px`;
            mainCanvas.style.height = `${canvasHeight}px`;
        }

        function clearCanvas() {
            drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height)
        }

        window.addEventListener('resize', setCanvasSize);
        setCanvasSize();

        let points = [];

        drawCanvas.width = refreshCanvas.width = mainCanvas.width
        drawCanvas.height = refreshCanvas.height = mainCanvas.height
        drawCtx.lineWidth = 3
        drawCtx.strokeStyle = '#3ac11f'
        refreshCtx.strokeStyle = '#aaa'
        refreshCtx.lineWidth = 3
        refreshCtx.setLineDash([3, 3])

        socket.on('connect', socket => {
            clearCanvas()
            document.querySelector('.disconnected').classList.remove('active')
            document.querySelector('.overlay').classList.remove('active')
        })
        socket.on('disconnect', socket => {
            document.querySelector('.disconnected').classList.add('active')
            document.querySelector('.overlay').classList.add('active')
        })

        socket.on('move', position => {
            points.push(position);
        })

        socket.on('history', history => {
            console.log("Received position history")
            points = history
        })

        function draw({x: xFrom,y: yFrom},{x: xTo,y: yTo}) {
            xFrom /= 4;
            yFrom /= 4;
            xTo /= 4;
            yTo /= 4;


            drawCtx.beginPath()
            drawCtx.moveTo(xFrom, yFrom)
            drawCtx.lineTo(xTo, yTo)
            drawCtx.stroke()
            drawCtx.closePath();

            refreshCtx.clearRect(0, 0, refreshCanvas.width, refreshCanvas.height)
            refreshCtx.beginPath()
            refreshCtx.moveTo(0, 0)
            refreshCtx.lineTo(xTo, yTo)
            refreshCtx.stroke()
            refreshCtx.moveTo(refreshCanvas.width, 0)
            refreshCtx.lineTo(xTo, yTo)
            refreshCtx.stroke()
            refreshCtx.closePath();
        }

        let lastPoint = null;

        function drawTo() {

            if (points.length > 0) {

                if (lastPoint === null) {
                    lastPoint = points.shift()
                }

                points.forEach(point => {
                    draw(lastPoint, point)
                    points.shift()
                    lastPoint = point;
                })


                mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height)
                mainCtx.drawImage(refreshCanvas, 0, 0)
                mainCtx.drawImage(drawCanvas, 0, 0)
            }

            requestAnimationFrame(drawTo)
        }

        requestAnimationFrame(drawTo)
    </script>
</body>
</html>
